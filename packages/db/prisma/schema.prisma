// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
  previewFeatures = ["driverAdapters"]
}

datasource db {
  provider = "sqlite"
  url      = "file:./dev.db"
}

// ============================================
// 멀티테넌트 핵심 모델
// ============================================

model Tenant {
  id        String @id @default(cuid())
  name      String // 회사명
  slug      String @unique // 서브도메인 슬러그 (예: client-a)
  subdomain String @unique // 전체 서브도메인 (예: client-a.myerp.com)

  // 브랜딩 설정
  logoUrl      String?
  primaryColor String? @default("#000000")

  // 메타데이터
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // 관계
  users           User[]
  customers       Customer[]
  products        Product[]
  orders          Order[]
  productVariants ProductVariant[]
  inventoryItems  InventoryItem[]
  orderItems      OrderItem[]
  productCatalogs ProductCatalog[]

  @@index([slug])
  @@index([subdomain])
  @@map("tenants")
}

// Enum 삭제됨: UserRole (SQLite 미지원)

model User {
  id       String   @id @default(cuid())
  email    String
  name     String?
  password String // 해시된 비밀번호
  role     String @default("MEMBER") // UserRole -> String

  // 테넌트 관계 (필수)
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // 메타데이터
  emailVerified DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@unique([tenantId, email])
  @@index([tenantId])
  @@index([email])
  @@map("users")
}

// ============================================
// CRM 모델
// ============================================

model Customer {
  id      String  @id @default(cuid())
  name    String
  email   String?
  phone   String?
  company String?

  // 주소 정보
  address String?
  city    String?
  state   String?
  zipCode String?
  country String?

  // 메모
  notes String?

  // 테넌트 관계 (필수)
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // 메타데이터
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // 관계
  orders Order[]

  @@index([tenantId])
  @@index([tenantId, email])
  @@map("customers")
}

// ============================================
// 상품 관리 모델
// ============================================

model Product {
  id          String  @id @default(cuid())
  name        String
  sku         String? // 상품 기본 SKU
  description String?
  category    String? // TODO: 추후 Category 모델로 분리 고려
  brand       String?

  // 이미지
  imageUrls String @default("[]") // SQLite에서는 JSON 문자열로 처리됨 (Prisma가 처리) -> 아님. Scalar list는 SQLite 미지원.
  // SQLite는 Scalar List 지원 안함. Json으로 바꿔야 함? 
  // Prisma + SQLite에서는 String[] 지원이 안됨. 
  // 대안 1: 별도 테이블. 대안 2: String으로 저장하고 구분자 사용.
  // 여기선 간단하게 imageUrls를 String으로 바꾸거나 Json으로 바꿔야 함.
  // 기존 코드 호환성을 위해 Json으로 바꾸는 것이 나을 듯. 아니면 String으로 하고 콤마 구분?
  // Prisma 공식 문서: SQLite does not support scalar lists.
  // Json 타입은 지원함.
  // 따라서 imageUrls String[] -> imageUrls String (comma separated) or Json.
  // 기존 코드 수정을 최소화하려면... Json이 나을듯. 하지만 타입이 바뀜.
  // 일단 여기서는 에러를 피하기 위해 String으로 변경하고 주석 남김.
  // 혹은, Relation으로 빼는게 정석임. ProductImage 모델 추가.
  // Phase 1이니까 일단 Json으로 처리하는게 제일 빠름.

  // 가격 정보 (옵션이 없는 경우를 위한 기본값, 옵션이 있으면 옵션 가격이 우선)
  price         Decimal? // @db.Decimal 제거
  consumerPrice Decimal?
  cost          Decimal?
  isTaxExempt   Boolean  @default(false) // 면세 여부

  // 배송 설정
  shippingType String?  @default("FREE") // FREE, FIXED, CONDITIONAL
  shippingFee  Decimal? @default(0)

  // 상품 정보 제공 고시 (JSON)
  noticeInfo String? @default("{}")

  // SEO 및 검색
  // tags            String[] @default([]) // SQLite Scalar List 미지원
  tags            String? // 콤마로 구분된 문자열로 저장한다고 가정

  metaTitle       String?
  metaDescription String?

  // 상태
  isDisplayed Boolean @default(true) // 진열 여부

  // 카탈로그 관계 (선택)
  catalogId String?
  catalog   ProductCatalog? @relation(fields: [catalogId], references: [id])

  // 테넌트 관계 (필수)
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // 메타데이터
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // 관계
  variants ProductVariant[]

  @@index([tenantId])
  @@index([tenantId, sku])
  @@index([tenantId, category])
  @@map("products")
}

model ProductCatalog {
  id          String   @id @default(cuid())
  name        String
  description String?
  category    String?
  brand       String?
  // imageUrls   String[] @default([]) // Scalar List 미지원
  imageUrls   String? 

  // 기본 스펙 정보
  specifications String? @default("{}")

  // 기준 가격 (참고용)
  defaultPrice Decimal?

  // 테넌트
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // 관계
  products Product[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId])
  @@map("product_catalogs")
}

model ProductVariant {
  id   String  @id @default(cuid())
  name String // 옵션명 (예: "사이즈 7, 골드")
  sku  String? // Variant별 SKU

  // 옵션 속성 (JSON으로 저장)
  attributes String @default("{}") // 예: {"size": "7", "color": "gold"}

  // 가격 및 재고
  price    Decimal 
  cost     Decimal? 
  quantity Int      @default(0) // 현재 재고 수량

  // 시리얼 넘버 추적 여부
  trackSerialNumbers Boolean @default(false)

  // 상품 관계 (필수)
  productId String
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  // 테넌트 관계 (필수) - 데이터 격리를 위해
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // 메타데이터
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // 관계
  inventoryItems InventoryItem[]
  orderItems     OrderItem[]

  @@index([tenantId])
  @@index([productId])
  @@index([tenantId, sku])
  @@map("product_variants")
}

model InventoryItem {
  id String @id @default(cuid())

  // 시리얼 넘버 및 배치 정보
  serialNumber String? @unique
  batchNumber  String?
  lotNumber    String?

  // 상태
  status String @default("AVAILABLE") // InventoryStatus -> String

  // 입고 정보
  receivedDate DateTime?
  expiryDate   DateTime?

  // 위치 정보
  location String? // 창고 위치 등

  // Variant 관계 (필수)
  variantId String
  variant   ProductVariant @relation(fields: [variantId], references: [id], onDelete: Cascade)

  // 테넌트 관계 (필수)
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // 메타데이터
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // 관계
  orderItems OrderItem[]

  @@index([tenantId])
  @@index([variantId])
  @@index([tenantId, serialNumber])
  @@index([tenantId, status])
  @@map("inventory_items")
}

// Enum 삭제됨: InventoryStatus

// ============================================
// 주문 관리 모델
// ============================================

// Enum 삭제됨: OrderStatus

model Order {
  id          String      @id @default(cuid())
  orderNumber String      @unique // 주문 번호 (예: ORD-2024-001)
  status      String @default("PENDING") // OrderStatus -> String

  // 금액 정보
  subtotal Decimal 
  tax      Decimal @default(0) 
  discount Decimal @default(0) 
  total    Decimal 

  // 배송 정보
  shippingAddress String?
  shippingMethod  String?
  trackingNumber  String?

  // 메모
  notes String?

  // 고객 관계
  customerId String?
  customer   Customer? @relation(fields: [customerId], references: [id], onDelete: SetNull)

  // 테넌트 관계 (필수)
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // 메타데이터
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  completedAt DateTime?

  // 관계
  items OrderItem[]

  @@index([tenantId])
  @@index([tenantId, status])
  @@index([tenantId, customerId])
  @@index([orderNumber])
  @@map("orders")
}

model OrderItem {
  id String @id @default(cuid())

  // 수량 및 가격
  quantity   Int
  unitPrice  Decimal 
  totalPrice Decimal // quantity * unitPrice

  // 주문 관계 (필수)
  orderId String
  order   Order  @relation(fields: [orderId], references: [id], onDelete: Cascade)

  // Variant 관계 (필수)
  variantId String
  variant   ProductVariant @relation(fields: [variantId], references: [id])

  // InventoryItem 관계 (시리얼 넘버 추적 시)
  inventoryItemId String?
  inventoryItem   InventoryItem? @relation(fields: [inventoryItemId], references: [id])

  // 테넌트 관계 (필수)
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // 메타데이터
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId])
  @@index([orderId])
  @@index([variantId])
  @@map("order_items")
}
